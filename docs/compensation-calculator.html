<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Compensation Calculator • ASFCP</title>
  <meta name="description" content="Search firearms and estimate total compensation by quantity.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
  <style>
    .toolbar { display: flex; gap: 12px; align-items: center; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr 1fr; } }
    .input { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: #0d1430; color: var(--text); }
    .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: #0f1840; color: var(--text); cursor: pointer; }
    .btn:hover { background: #111c4a; }
    .btn-primary { background: var(--accent); color: #06122e; border-color: transparent; }
    .btn-primary:hover { filter: brightness(0.95); }
    .muted { color: var(--muted); }
    .list { margin: 0; padding: 0; list-style: none; }
    .list li { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); gap: 12px; }
    .list li:last-child { border-bottom: none; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); background: #0f1640; font-size: 12px; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
    .table input[type=number] { width: 90px; }
    .right { text-align: right; }
    .total { font-weight: 700; font-size: 18px; }
    .error { color: #ff7b7b; }
    .skeleton { background: linear-gradient(90deg, #0e1430, #111a3b, #0e1430); background-size: 200% 100%; animation: shimmer 1.2s infinite; height: 18px; border-radius: 6px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1>Compensation Calculator</h1>
      <p class="subtitle">Search firearms and estimate total compensation by quantity.</p>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="panel">
        <h2 style="margin-top:0">Search catalog</h2>
        <div class="toolbar" style="margin-bottom: 12px;">
          <input id="search" class="input" type="search" placeholder="Search by make, model, or reference number…" aria-label="Search firearms" />
          <button id="clearSearch" class="btn" type="button">Clear</button>
        </div>
        <div id="results">
          <div class="skeleton" style="width: 60%; margin: 10px 0;"></div>
          <div class="skeleton" style="width: 80%; margin: 10px 0;"></div>
          <div class="skeleton" style="width: 70%; margin: 10px 0;"></div>
        </div>
        <p id="loadError" class="error" style="display:none"></p>
      </section>

      <section class="panel">
        <h2 style="margin-top:0">Your selection</h2>
        <div style="overflow-x:auto">
          <table class="table" id="selectionTable" aria-describedby="selectionHelp">
            <thead>
              <tr>
                <th style="min-width:120px">Ref #</th>
                <th>Make</th>
                <th>Model</th>
                <th class="right">Compensation</th>
                <th class="right">Purchase Year</th>
                <th class="right">Purchase Price</th>
                <th class="right">Inflation Adj. Purchase Price</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="selectionBody">
              <tr id="emptyRow"><td colspan="8" class="muted">No items added yet.</td></tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="6" class="right total">Total Purchase</td>
                <td class="right total" id="totalPurchase">$0</td>
                <td></td>
              </tr>
              <tr>
                <td colspan="6" class="right total">Total Inflation-Adjusted Purchase</td>
                <td class="right total" id="totalPurchaseAdj">$0</td>
                <td></td>
              </tr>
              <tr>
                <td colspan="6" class="right total">Total Compensation</td>
                <td class="right total" id="totalCompensation">$0</td>
                <td></td>
              </tr>
              <tr>
                <td colspan="6" class="right total">Total Difference (Compensation − Inflation-Adjusted Purchase)</td>
                <td class="right total" id="totalDifference">$0</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <p id="selectionHelp" class="muted">Enter the year purchased and purchase price for each firearm. Totals show purchase sum and compensation sum.</p>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p><a href="./index.html">← Back to docs home</a></p>
      <p class="muted" style="margin-top:8px">
        Disclaimer: Inflation adjustments are approximate and based on annual CPI averages. This tool is for informational purposes only and may not reflect official compensation calculations.
      </p>
      <p class="muted" style="margin-top:6px">
        Privacy: What you enter/select here is processed locally in your browser only. No data is stored or sent to any server. Closing this tab clears your inputs.
      </p>
    </div>
  </footer>

  <script>
    const DATA_URL = 'https://raw.githubusercontent.com/muz/asfcp/refs/heads/main/data/firearms_data_1758679491.json';

    /** State **/
    let catalog = [];
    const selected = []; // array of { item, year, purchasePrice, id }

    /** DOM **/
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('clearSearch');
    const resultsEl = document.getElementById('results');
    const selectionBody = document.getElementById('selectionBody');
    const emptyRow = document.getElementById('emptyRow');
    const totalCompensationEl = document.getElementById('totalCompensation');
    const totalPurchaseEl = document.getElementById('totalPurchase');
    const totalPurchaseAdjEl = document.getElementById('totalPurchaseAdj');
    const totalDifferenceEl = document.getElementById('totalDifference');
    const loadErrorEl = document.getElementById('loadError');

    // CPI data (inline annual averages)
    let yearToAvgCPI = {}; // { [year]: average CPI }
    let referenceCPI = null; // latest available annual average CPI

    function formatCurrency(cents) {
      try {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'CAD', maximumFractionDigits: 0 }).format(cents);
      } catch (_) {
        return '$' + (cents || 0).toString();
      }
    }

    function renderResults(list) {
      if (!Array.isArray(list) || list.length === 0) {
        resultsEl.innerHTML = '<p class="muted">No results. Try a different search.</p>';
        return;
      }
      resultsEl.innerHTML = '<ul class="list">' + list.map(item => {
        const key = item.firearm_reference_number;
        return `
          <li>
            <div style="min-width:0;">
              <div><strong>${key}</strong> · ${escapeHtml(item.make)} — ${escapeHtml(item.model)}</div>
              <div class="muted">Compensation: <span class="pill">${formatCurrency(item.individual_amount)}</span></div>
            </div>
            <div>
              <button class="btn" data-add="${key}">Add</button>
            </div>
          </li>`;
      }).join('') + '</ul>';

      // Attach handlers
      resultsEl.querySelectorAll('[data-add]').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.getAttribute('data-add');
          const item = catalog.find(x => x.firearm_reference_number === key);
          if (!item) return;
          const id = Date.now() + Math.random(); // unique ID for this instance
          selected.push({ item, year: '', purchasePrice: '', id });
          renderSelection();
        });
      });
    }

    function renderSelection() {
      if (selected.length === 0) {
        selectionBody.innerHTML = '<tr id="emptyRow"><td colspan="7" class="muted">No items added yet.</td></tr>';
        totalCompensationEl.textContent = '$0';
        totalPurchaseEl.textContent = '$0';
        return;
      }

      selectionBody.innerHTML = selected.map(({ item, year, purchasePrice, id }) => {
        const ref = item.firearm_reference_number;
        const compensation = Number(item.individual_amount) || 0;
        return `
          <tr>
            <td>${ref}</td>
            <td>${escapeHtml(item.make)}</td>
            <td>${escapeHtml(item.model)}</td>
            <td class="right">${formatCurrency(compensation)}</td>
            <td class="right">
              <input type="number" min="1914" max="2025" step="1" value="${year}" data-year="${id}" placeholder="Year" style="width: 80px;" />
            </td>
            <td class="right">
              <input type="number" min="0" step="1" value="${purchasePrice}" data-price="${id}" placeholder="0" style="width: 100px;" />
            </td>
            <td class="right"><span data-adjusted="${id}">$0</span></td>
            <td class="right">
              <button class="btn" data-remove="${id}">Remove</button>
            </td>
          </tr>`;
      }).join('');

      updateTotals();

      // Bind year, price and remove events
      selectionBody.querySelectorAll('[data-year]').forEach(input => {
        input.addEventListener('input', () => {
          const id = input.getAttribute('data-year');
          const entry = selected.find(x => x.id == id);
          if (!entry) return;
          entry.year = input.value;
          updateTotals();
        });
      });
      selectionBody.querySelectorAll('[data-price]').forEach(input => {
        input.addEventListener('input', () => {
          const id = input.getAttribute('data-price');
          const entry = selected.find(x => x.id == id);
          if (!entry) return;
          entry.purchasePrice = input.value;
          updateTotals();
        });
      });
      selectionBody.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-remove');
          const index = selected.findIndex(x => x.id == id);
          if (index >= 0) {
            selected.splice(index, 1);
            renderSelection();
          }
        });
      });
    }

    function updateTotals() {
      let totalCompensation = 0;
      let totalPurchase = 0;
      let totalPurchaseAdj = 0;
      selected.forEach(({ item, purchasePrice, year, id }) => {
        const comp = Number(item.individual_amount) || 0;
        const price = Number(purchasePrice) || 0;
        totalCompensation += comp;
        totalPurchase += price;
        let adj = 0;
        const y = parseInt(year, 10);
        if (Number.isFinite(y) && y >= 1914) {
          if (y >= 2025) {
            adj = price; // latest year available—no adjustment beyond 2025
          } else if (yearToAvgCPI[y] && referenceCPI) {
            const factor = referenceCPI / yearToAvgCPI[y];
            adj = Math.round(price * factor);
          }
        }
        totalPurchaseAdj += adj;
        const span = selectionBody.querySelector(`[data-adjusted="${id}"]`);
        if (span) span.textContent = formatCurrency(adj);
      });
      totalCompensationEl.textContent = formatCurrency(totalCompensation);
      totalPurchaseEl.textContent = formatCurrency(totalPurchase);
      totalPurchaseAdjEl.textContent = formatCurrency(totalPurchaseAdj);
      totalDifferenceEl.textContent = formatCurrency(totalCompensation - totalPurchaseAdj);
    }

    // Initialize CPI from inline JSON after the page fully loads,
    // because the <script id="cpi-data"> tag is placed after this script block.
    window.addEventListener('load', () => {
      try {
        const el = document.getElementById('cpi-data');
        if (!el) throw new Error('Missing inline CPI data');
        const obj = JSON.parse(el.textContent || '{}');
        yearToAvgCPI = obj || {};
        const years = Object.keys(yearToAvgCPI)
          .map(n => parseInt(n,10))
          .filter(n => Number.isFinite(n))
          .sort((a,b)=>a-b);
        referenceCPI = years.length ? yearToAvgCPI[years[years.length - 1]] : null;
      } catch (e) {
        console.error(e);
      }
      updateTotals();
    });

    function debounce(fn, wait) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }

    function escapeHtml(str) {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    const doSearch = debounce(() => {
      const q = (searchInput.value || '').toLowerCase().trim();
      if (!q) {
        renderResults(catalog.slice(0, 25));
        return;
      }
      const results = catalog.filter(item => {
        const hay = [
          item.firearm_reference_number,
          item.make,
          item.model
        ].join(' ').toLowerCase();
        return hay.includes(q);
      }).slice(0, 50);
      renderResults(results);
    }, 150);

    async function init() {
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to load data: ' + res.status);
        const data = await res.json();
        // Normalize and ensure amount is integer
        catalog = (Array.isArray(data) ? data : []).map(x => ({
          firearm_reference_number: String(x.firearm_reference_number || '').trim(),
          make: String(x.make || ''),
          model: String(x.model || ''),
          individual_amount: Number.isFinite(Number(x.individual_amount)) ? parseInt(Number(x.individual_amount)) : 0
        }));
        renderResults(catalog.slice(0, 25));
      } catch (err) {
        console.error(err);
        resultsEl.innerHTML = '';
        loadErrorEl.style.display = '';
        loadErrorEl.textContent = 'Error loading data. Please refresh to retry.';
      }
    }

    searchInput.addEventListener('input', doSearch);
    clearBtn.addEventListener('click', () => { searchInput.value = ''; doSearch(); searchInput.focus(); });
    init();
  </script>
  <script type="application/json" id="cpi-data">
  {
    "1914": 10.3,
    "1915": 10.6,
    "1916": 11.3,
    "1917": 13.1,
    "1918": 15.1,
    "1919": 16.0,
    "1920": 16.8,
    "1921": 14.6,
    "1922": 13.5,
    "1923": 13.7,
    "1924": 13.6,
    "1925": 13.8,
    "1926": 14.4,
    "1927": 14.1,
    "1928": 13.9,
    "1929": 13.8,
    "1930": 13.0,
    "1931": 11.2,
    "1932": 10.3,
    "1933": 10.0,
    "1934": 10.1,
    "1935": 10.4,
    "1936": 10.5,
    "1937": 10.9,
    "1938": 10.7,
    "1939": 10.8,
    "1940": 11.3,
    "1941": 12.6,
    "1942": 14.0,
    "1943": 14.7,
    "1944": 15.0,
    "1945": 15.3,
    "1946": 16.5,
    "1947": 19.1,
    "1948": 20.5,
    "1949": 20.3,
    "1950": 20.8,
    "1951": 22.6,
    "1952": 22.8,
    "1953": 22.9,
    "1954": 23.0,
    "1955": 23.2,
    "1956": 23.9,
    "1957": 24.9,
    "1958": 25.5,
    "1959": 25.9,
    "1960": 26.4,
    "1961": 26.7,
    "1962": 27.3,
    "1963": 28.1,
    "1964": 28.9,
    "1965": 29.6,
    "1966": 31.0,
    "1967": 32.2,
    "1968": 33.8,
    "1969": 36.1,
    "1970": 38.4,
    "1971": 40.0,
    "1972": 41.5,
    "1973": 44.1,
    "1974": 49.8,
    "1975": 55.3,
    "1976": 59.0,
    "1977": 62.9,
    "1978": 67.1,
    "1979": 74.3,
    "1980": 84.4,
    "1981": 94.0,
    "1982": 102.0,
    "1983": 106.0,
    "1984": 109.6,
    "1985": 113.0,
    "1986": 116.2,
    "1987": 120.0,
    "1988": 124.0,
    "1989": 129.0,
    "1990": 134.2,
    "1991": 139.8,
    "1992": 141.9,
    "1993": 143.4,
    "1994": 144.6,
    "1995": 146.9,
    "1996": 148.4,
    "1997": 149.8,
    "1998": 150.9,
    "1999": 153.0,
    "2000": 158.6,
    "2001": 162.6,
    "2002": 164.5,
    "2003": 168.2,
    "2004": 171.2,
    "2005": 176.0,
    "2006": 180.2,
    "2007": 184.0,
    "2008": 189.9,
    "2009": 188.7,
    "2010": 191.5,
    "2011": 197.9,
    "2012": 200.5,
    "2013": 202.3,
    "2014": 204.8,
    "2015": 205.7,
    "2016": 208.0,
    "2017": 211.1,
    "2018": 215.3,
    "2019": 220.8,
    "2020": 221.6,
    "2021": 229.7,
    "2022": 244.6,
    "2023": 251.1,
    "2024": 256.8
  }
  </script>
</body>
</html>


